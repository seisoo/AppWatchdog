name: Publish & Release (Windows)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: self-hosted

    steps:
      # 1ï¸âƒ£ Checkout (FULL history required for tagging)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Read version from project
      - name: Read project version
        shell: powershell
        run: |
          [xml]$props = Get-Content Directory.Build.props
          $version = $props.Project.PropertyGroup.Version

          if (-not $version) {
            Write-Error 'Version not found in Directory.Build.props'
            exit 1
          }

          'VERSION=' + $version | Out-File $env:GITHUB_ENV -Append
          'TAG=v' + $version | Out-File $env:GITHUB_ENV -Append

      # 3ï¸âƒ£ Ensure tag does NOT already exist
      - name: Delete tag if it exists (local + remote)
        shell: powershell
        run: |
          git fetch --tags

          if (git tag -l '${{ env.TAG }}') {
            Write-Host 'Tag exists â€“ deleting'
            git tag -d '${{ env.TAG }}'
            git push origin ':refs/tags/${{ env.TAG }}'
          }

      # 4ï¸âƒ£ Create and push tag
      - name: Create and push tag
        shell: powershell
        run: |
          git tag '${{ env.TAG }}'
          git push origin '${{ env.TAG }}'

      # 5ï¸âƒ£ Restore
      - name: Restore
        run: dotnet restore AppWatchdog.sln

      # =========================
      # ðŸ”¹ BUILD ALL TARGETS
      # =========================
      - name: Publish Service + UI (all RIDs)
        shell: powershell
        run: |
          $targets = 'win-x64','win-x86','win-arm64'

          foreach ($t in $targets) {
            dotnet publish AppWatchdog.Service/AppWatchdog.Service.csproj `
              -c Release -r $t --self-contained true `
              /p:PublishSingleFile=true `
              /p:PublishTrimmed=false `
              /p:IncludeNativeLibrariesForSelfExtract=true

            dotnet publish AppWatchdog.UI.WPF/AppWatchdog.UI.WPF.csproj `
              -c Release -r $t --self-contained true `
              /p:PublishSingleFile=true `
              /p:PublishTrimmed=false `
              /p:IncludeNativeLibrariesForSelfExtract=true
          }

      # =========================
      # ðŸ“¦ COLLECT + ZIP
      # =========================
      - name: Collect Outputs + ZIPs
        shell: powershell
        run: |
          $targets = 'win-x64','win-x86','win-arm64'

          foreach ($t in $targets) {
            $outDir = 'release\' + $t
            New-Item -ItemType Directory -Force $outDir | Out-Null

            Copy-Item "AppWatchdog.Service/bin/Release/net8.0-windows/$t/publish/AppWatchdog.Service.exe" $outDir -Force
            Copy-Item "AppWatchdog.UI.WPF/bin/Release/net8.0-windows/$t/publish/AppWatchdog.UI.WPF.exe" $outDir -Force

            Compress-Archive "$outDir\*" "AppWatchdog_${{ env.TAG }}_$t.zip" -Force
          }

      # =========================
      # ðŸ“¦ Generate changelog
      # =========================
      - name: Generate changelog
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --tags

          $repo = "${{ github.repository }}"
          $currentTag = "${{ env.TAG }}"

          $prevTag = git tag --sort=-creatordate |
            Where-Object { $_ -ne $currentTag } |
            Select-Object -First 1

          if (-not $prevTag) {
            Write-Host "No previous tag â€“ first release"
            $compareUrl = "https://github.com/$repo/releases/tag/$currentTag"
          }
          else {
            $compareUrl = "https://github.com/$repo/compare/$prevTag...$currentTag"
          }

          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
          }

          $prs = @()

          if ($prevTag) {
            $prs = Invoke-RestMethod `
              -Headers $headers `
              -Uri "https://api.github.com/repos/$repo/pulls?state=closed&base=main&per_page=100"
          }

          $changes = @()

          foreach ($pr in $prs) {
            if ($pr.merged_at) {
              if ($prevTag) {
                $mergeSha = $pr.merge_commit_sha
                $isInRange = git merge-base --is-ancestor $prevTag $mergeSha 2>$null
                if ($LASTEXITCODE -ne 0) { continue }
              }

              $entry = "* **$($pr.title)**"

              if ($pr.body) {
                $cleanBody = $pr.body.Trim() -replace "`r?`n", " "
                $entry += " â€“ $cleanBody"
              }

              $entry += " by @$($pr.user.login) in $($pr.html_url)"
              $changes += $entry
            }
          }

          if ($changes.Count -eq 0) {
            $changes = @("* No user-visible changes")
          }

          $output = @()
          $output += "## What's Changed"
          $output += ""
          $output += $changes
          $output += ""
          $output += "**Full Changelog**: $compareUrl"

          $output | Out-File changelog.txt -Encoding utf8



      # =========================
      # ðŸš€ GITHUB RELEASE
      # =========================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: AppWatchdog ${{ env.TAG }}
          body_path: changelog.txt
          replace_existing_tag: true
          files: |
            AppWatchdog_${{ env.TAG }}_win-x64.zip
            AppWatchdog_${{ env.TAG }}_win-x86.zip
            AppWatchdog_${{ env.TAG }}_win-arm64.zip
