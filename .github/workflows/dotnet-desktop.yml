name: Publish & Release (Windows)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout (FULL history required for tagging)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Read version from project
      - name: Read project version
        id: version
        shell: powershell
        run: |
          [xml]$props = Get-Content Directory.Build.props
          $version = $props.Project.PropertyGroup.Version
          if (-not $version) {
            Write-Error "Version not found in Directory.Build.props"
            exit 1
          }

          echo "VERSION=$version" >> $env:GITHUB_ENV
          echo "TAG=v$version" >> $env:GITHUB_ENV

      # 3Ô∏è‚É£ Ensure tag does NOT already exist
      - name: Delete tag if it exists (local + remote)
        shell: powershell
        run: |
            git fetch --tags
        
            if (git tag -l "${{ env.TAG }}") {
              Write-Host "Tag ${{ env.TAG }} exists ‚Äì deleting it"
        
              # delete local tag
              git tag -d "${{ env.TAG }}"
        
              # delete remote tag
              git push origin ":refs/tags/${{ env.TAG }}"
            } else {
              Write-Host "Tag ${{ env.TAG }} does not exist ‚Äì creating new"
            }


      # 4Ô∏è‚É£ Create and push tag
      - name: Create and push tag
        shell: powershell
        run: |
          git tag "${{ env.TAG }}"
          git push origin "${{ env.TAG }}"

      # 5Ô∏è‚É£ Restore
      - name: Restore
        run: dotnet restore AppWatchdog.sln

      # =========================
      # üîπ BUILD ALL TARGETS
      # =========================
      - name: Publish Service + UI (all RIDs)
        shell: powershell
        run: |
          $targets = @("win-x64", "win-x86", "win-arm64")

          foreach ($t in $targets) {
            dotnet publish AppWatchdog.Service/AppWatchdog.Service.csproj `
              -c Release -r $t --self-contained true `
              /p:PublishSingleFile=true `
              /p:PublishTrimmed=false `
              /p:IncludeNativeLibrariesForSelfExtract=true

            dotnet publish AppWatchdog.UI.WPF/AppWatchdog.UI.WPF.csproj `
              -c Release -r $t --self-contained true `
              /p:PublishSingleFile=true `
              /p:PublishTrimmed=false `
              /p:IncludeNativeLibrariesForSelfExtract=true
          }

      # =========================
      # üì¶ COLLECT + ZIP
      # =========================
      - name: Generate changelog
        shell: powershell
        run: |
          git fetch --tags

          $currentTag = "${{ env.TAG }}"

          # Get previous tag (exclude current)
          $prevTag = git tag --sort=-creatordate |
                     Where-Object { $_ -ne $currentTag } |
                     Select-Object -First 1

          if (-not $prevTag) {
            Write-Host "No previous tag found ‚Äì using full history"
            $log = git log "$currentTag" --pretty=format:"- %s"
          } else {
            Write-Host "Generating changelog from $prevTag to $currentTag"
            $log = git log "$prevTag..$currentTag" --pretty=format:"- %s"
          }

          if (-not $log) {
            $log = "- No code changes"
          }

          $log | Out-File changelog.txt -Encoding utf8


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: AppWatchdog ${{ env.TAG }}
          body_path: changelog.txt
          replace_existing_tag: true
          files: |
            AppWatchdog_${{ env.TAG }}_win-x64.zip
            AppWatchdog_${{ env.TAG }}_win-x86.zip
            AppWatchdog_${{ env.TAG }}_win-arm64.zip


