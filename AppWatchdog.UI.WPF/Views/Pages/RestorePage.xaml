<Page
    x:Class="AppWatchdog.UI.WPF.Views.Pages.RestorePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="clr-namespace:AppWatchdog.UI.WPF.Converters"
    xmlns:local="clr-namespace:AppWatchdog.UI.WPF.ViewModels"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml">

    <Page.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <conv:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
    </Page.Resources>

    <Grid VerticalAlignment="Stretch" IsEnabled="{Binding IsContentEnabled}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Margin="16,16,16,0">

            <!--  HEADER CARD  -->
            <ui:Card Margin="0,0,0,16" Padding="20">
                <StackPanel>
                    <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                        <ui:SymbolIcon
                            Margin="0,0,12,0"
                            FontSize="32"
                            Symbol="ArrowUpload24" />
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock
                                FontSize="24"
                                FontWeight="Bold"
                                Text="{Binding Source={StaticResource Strings}, Path=[restore_title]}" />
                            <TextBlock
                                Margin="0,4,0,0"
                                FontSize="12"
                                Opacity="0.6"
                                Text="{Binding Source={StaticResource Strings}, Path=[restore_description]}" />
                        </StackPanel>
                    </StackPanel>

                    <WrapPanel Margin="0,16,0,0">
                        <ui:Button
                            Margin="0,0,12,0"
                            Command="{Binding ReloadPlansCommand}"
                            Content="{Binding Source={StaticResource Strings}, Path=[restore_reload_plans]}"
                            Icon="{ui:SymbolIcon Symbol=ArrowClockwise24}" />
                        <ui:Button
                            Margin="0,0,12,0"
                            Command="{Binding BrowseRestoreDirectoryCommand}"
                            Content="{Binding Source={StaticResource Strings}, Path=[restore_browse_folder]}"
                            Icon="{ui:SymbolIcon Symbol=Folder24}" />
                        <ui:Button
                            Appearance="Primary"
                            Command="{Binding TriggerRestoreCommand}"
                            Content="{Binding Source={StaticResource Strings}, Path=[restore_start]}"
                            Icon="{ui:SymbolIcon Symbol=Play24}"
                            IsEnabled="{Binding CanRestore}" />
                    </WrapPanel>
                </StackPanel>
            </ui:Card>

        </StackPanel>

        <!--  MAIN CONTENT GRID  -->
        <Grid Grid.Row="1" Margin="16,0,16,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="380" />
                <ColumnDefinition Width="16" />
                <ColumnDefinition Width="*" MinWidth="400" />
            </Grid.ColumnDefinitions>

            <!--  LEFT COLUMN: PLANS & ARTIFACTS  -->
            <ScrollViewer
                Grid.Column="0"
                CanContentScroll="False"
                HorizontalScrollBarVisibility="Disabled"
                VerticalScrollBarVisibility="Auto">
                <StackPanel>

                    <!--  BACKUP PLANS  -->
                    <ui:Card Margin="0,0,0,12" Padding="16">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="180" />
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0">
                                <StackPanel Margin="0,0,0,8" Orientation="Horizontal">
                                    <ui:SymbolIcon
                                        Margin="0,0,8,0"
                                        FontSize="18"
                                        Symbol="Save24" />
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Text="{Binding Source={StaticResource Strings}, Path=[backup_plans_title]}" />
                                </StackPanel>
                                <TextBlock
                                    Margin="0,2,0,0"
                                    FontSize="11"
                                    Opacity="0.6"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_plans_hint]}"
                                    TextWrapping="Wrap" />
                                <Separator Margin="0,12,0,12" />
                            </StackPanel>

                            <Grid Grid.Row="1">
                                <ui:ProgressRing
                                    Width="40"
                                    Height="40"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    IsIndeterminate="True"
                                    Visibility="{Binding IsLoadingPlans, Converter={StaticResource BoolToVisibilityConverter}}" />

                                <ui:ListView
                                    ItemsSource="{Binding Plans}"
                                    ScrollViewer.VerticalScrollBarVisibility="Visible"
                                    SelectedItem="{Binding SelectedPlan}"
                                    Visibility="{Binding IsLoadingPlans, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                    <ui:ListView.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="8,10">
                                                <StackPanel Orientation="Horizontal">
                                                    <ui:SymbolIcon
                                                        Margin="0,0,6,0"
                                                        FontSize="14"
                                                        Symbol="FolderOpen24" />
                                                    <TextBlock
                                                        FontWeight="SemiBold"
                                                        Text="{Binding Name}"
                                                        TextWrapping="Wrap" />
                                                </StackPanel>
                                                <TextBlock
                                                    Margin="0,2,0,0"
                                                    FontSize="10"
                                                    Opacity="0.5"
                                                    Text="{Binding Id}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ui:ListView.ItemTemplate>
                                </ui:ListView>
                            </Grid>
                        </Grid>
                    </ui:Card>

                    <!--  BACKUP ARTIFACTS  -->
                    <ui:Card Padding="16" IsEnabled="{Binding HasSelectedPlan}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="180" />
                            </Grid.RowDefinitions>
                            <StackPanel Grid.Row="0">
                                <StackPanel Margin="0,0,0,8" Orientation="Horizontal">
                                    <ui:SymbolIcon
                                        Margin="0,0,8,0"
                                        FontSize="18"
                                        Symbol="Archive24" />
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Text="{Binding Source={StaticResource Strings}, Path=[restore_artifacts_title]}" />
                                </StackPanel>
                                <TextBlock
                                    Margin="0,2,0,0"
                                    FontSize="11"
                                    Opacity="0.6"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_artifacts_hint]}"
                                    TextWrapping="Wrap" />
                                <Separator Margin="0,12,0,12" />
                            </StackPanel>

                            <Grid Grid.Row="1">
                                <ui:ProgressRing
                                    Width="40"
                                    Height="40"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    IsIndeterminate="True"
                                    Visibility="{Binding IsLoadingArtifacts, Converter={StaticResource BoolToVisibilityConverter}}" />

                                <ui:ListView
                                    ItemsSource="{Binding Artifacts}"
                                    ScrollViewer.VerticalScrollBarVisibility="Visible"
                                    SelectedItem="{Binding SelectedArtifact}"
                                    Visibility="{Binding IsLoadingArtifacts, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                    <ui:ListView.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="8,10">
                                                <StackPanel Orientation="Horizontal">
                                                    <ui:SymbolIcon
                                                        Margin="0,0,6,0"
                                                        FontSize="14"
                                                        Symbol="Database24" />
                                                    <TextBlock
                                                        FontWeight="SemiBold"
                                                        Text="{Binding DisplayCreatedLocal}"
                                                        TextWrapping="Wrap" />
                                                </StackPanel>
                                                <TextBlock
                                                    Margin="0,2,0,0"
                                                    FontSize="10"
                                                    Opacity="0.5"
                                                    Text="{Binding Name}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ui:ListView.ItemTemplate>
                                </ui:ListView>
                            </Grid>
                        </Grid>
                    </ui:Card>

                </StackPanel>
            </ScrollViewer>

            <!--  RIGHT COLUMN: RESTORE CONFIGURATION  -->
            <ui:Card
                Grid.Column="2"
                Padding="16"
                VerticalAlignment="Top">
                <ScrollViewer
                    CanContentScroll="False"
                    HorizontalScrollBarVisibility="Disabled"
                    VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!--  HEADER  -->
                        <StackPanel Margin="0,0,0,12">
                            <StackPanel Margin="0,0,0,8" Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,8,0"
                                    FontSize="18"
                                    Symbol="Settings24" />
                                <TextBlock
                                    VerticalAlignment="Center"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_configuration_title]}" />
                            </StackPanel>
                            <TextBlock
                                FontSize="11"
                                Opacity="0.6"
                                Text="{Binding ManifestSummary}"
                                TextWrapping="Wrap" />
                        </StackPanel>

                        <!--  WARNINGS  -->
                        <ui:InfoBar
                            Title="{Binding Source={StaticResource Strings}, Path=[restore_blocked_title]}"
                            Margin="0,0,0,12"
                            IsOpen="{Binding HasWarnings}"
                            Message="{Binding WarningText}"
                            Severity="Warning" />

                        <!--  RESTORE DETAILS  -->
                        <StackPanel Margin="0,0,0,12">
                            <StackPanel Margin="0,0,0,6" Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    FontSize="16"
                                    Symbol="Link24" />
                                <TextBlock
                                    FontSize="13"
                                    FontWeight="SemiBold"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_details_title]}" />
                            </StackPanel>
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="11"
                                Opacity="0.6"
                                Text="{Binding ChainSummary}"
                                TextWrapping="Wrap" />

                            <ui:ProgressRing
                                Width="28"
                                Height="28"
                                Margin="0,8,0,8"
                                HorizontalAlignment="Center"
                                IsIndeterminate="True"
                                Visibility="{Binding IsLoadingManifest, Converter={StaticResource BoolToVisibilityConverter}}" />

                            <ItemsControl ItemsSource="{Binding RestoreChain}" Visibility="{Binding IsLoadingManifest, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Padding="0,6"
                                            BorderThickness="0,0,0,1"
                                            Opacity="0.7">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon
                                                    Margin="0,0,8,0"
                                                    FontSize="14"
                                                    Symbol="{Binding Icon}" />
                                                <StackPanel>
                                                    <TextBlock
                                                        FontSize="12"
                                                        FontWeight="SemiBold"
                                                        Text="{Binding Title}" />
                                                    <TextBlock
                                                        FontSize="10"
                                                        Opacity="0.7"
                                                        Text="{Binding Subtitle}"
                                                        TextWrapping="Wrap" />
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!--  RESTORE DIRECTORY  -->
                        <StackPanel Margin="0,0,0,12" IsEnabled="{Binding HasSelectedArtifact}">
                            <StackPanel Margin="0,0,0,6" Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    FontSize="16"
                                    Symbol="ArrowDownload24" />
                                <TextBlock
                                    FontSize="13"
                                    FontWeight="SemiBold"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_location_title]}" />
                            </StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="8" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <ui:TextBox Text="{Binding RestoreToDirectory, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <ui:Button
                                    Grid.Column="2"
                                    Padding="12,6"
                                    Command="{Binding BrowseRestoreDirectoryCommand}"
                                    Icon="{ui:SymbolIcon Symbol=Folder24}" />
                            </Grid>

                            <ui:ToggleSwitch
                                Margin="0,8,0,0"
                                Content="{Binding Source={StaticResource Strings}, Path=[restore_overwrite_toggle]}"
                                IsChecked="{Binding OverwriteExisting, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                IsEnabled="{Binding IsOverwriteToggleEnabled}" />
                            <TextBlock
                                Margin="0,4,0,0"
                                FontSize="10"
                                Opacity="0.6"
                                Text="{Binding OverwriteHint}"
                                TextWrapping="Wrap" />
                        </StackPanel>

                        <!--  FILE TREE  -->
                        <StackPanel Margin="0,0,0,0" IsEnabled="{Binding HasSelectedArtifact}">
                            <StackPanel Margin="0,0,0,6" Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    FontSize="16"
                                    Symbol="DocumentMultiple24" />
                                <TextBlock
                                    FontSize="13"
                                    FontWeight="SemiBold"
                                    Text="{Binding Source={StaticResource Strings}, Path=[restore_files_title]}" />
                            </StackPanel>
                            <TextBlock
                                Margin="0,0,0,6"
                                FontSize="10"
                                Opacity="0.6"
                                Text="{Binding Source={StaticResource Strings}, Path=[restore_files_hint]}"
                                TextWrapping="Wrap" />

                            <Border
                                MinHeight="100"
                                MaxHeight="200"
                                BorderThickness="1"
                                CornerRadius="6"
                                Opacity="0.8">
                                <ScrollViewer
                                    CanContentScroll="False"
                                    HorizontalScrollBarVisibility="Disabled"
                                    VerticalScrollBarVisibility="Auto">
                                    <TreeView ItemsSource="{Binding ManifestTree}">
                                        <TreeView.Resources>
                                            <HierarchicalDataTemplate DataType="{x:Type local:ManifestTreeNode}" ItemsSource="{Binding Children}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <ui:SymbolIcon FontSize="12" Symbol="{Binding Icon}" />
                                                    <CheckBox
                                                        Grid.Column="1"
                                                        Margin="6,0,0,0"
                                                        VerticalAlignment="Center"
                                                        IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                                    <TextBlock
                                                        Grid.Column="2"
                                                        Margin="6,0,0,0"
                                                        VerticalAlignment="Center"
                                                        FontSize="11"
                                                        Text="{Binding Name}" />
                                                </Grid>
                                            </HierarchicalDataTemplate>
                                        </TreeView.Resources>
                                    </TreeView>
                                </ScrollViewer>
                            </Border>

                            <!--  SELECTION SUMMARY & ACTIONS  -->
                            <StackPanel Margin="0,8,0,0">
                                <TextBlock
                                    FontSize="11"
                                    Opacity="0.7"
                                    Text="{Binding SelectionSummary}"
                                    TextWrapping="Wrap" />
                                <WrapPanel Margin="0,6,0,0">
                                    <ui:Button
                                        Margin="0,0,8,0"
                                        Padding="10,4"
                                        Command="{Binding SelectAllCommand}"
                                        Content="{Binding Source={StaticResource Strings}, Path=[restore_select_all]}"
                                        Icon="{ui:SymbolIcon Symbol=CheckmarkSquare24}"
                                        IsEnabled="{Binding HasManifest}" />
                                    <ui:Button
                                        Padding="10,4"
                                        Command="{Binding SelectNoneCommand}"
                                        Content="{Binding Source={StaticResource Strings}, Path=[restore_select_none]}"
                                        Icon="{ui:SymbolIcon Symbol=Square24}"
                                        IsEnabled="{Binding HasManifest}" />
                                </WrapPanel>
                            </StackPanel>
                        </StackPanel>

                        <TextBlock Margin="0,24,0,0" />
                    </StackPanel>
                </ScrollViewer>
            </ui:Card>
        </Grid>

    </Grid>
</Page>
